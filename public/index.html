<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FruTropics Content Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="logo">
        <i class="fas fa-leaf"></i>
        <h1>FruTropics Dashboard</h1>
      </div>
      <div class="header-actions">
        <button onclick="triggerUpload()" class="btn btn-secondary">
          <i class="fas fa-sync-alt"></i>
          <span>Pull New Images</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Social Links Bar -->
  <nav class="social-nav">
    <div class="social-links">
      <a href="https://www.reddit.com/r/wttt_official/" target="_blank" class="social-link">
        <i class="fab fa-reddit"></i>
        <span>Reddit</span>
      </a>
      <a href="https://www.instagram.com/wttt_official/" target="_blank" class="social-link">
        <i class="fab fa-instagram"></i>
        <span>Instagram</span>
      </a>
      <a href="https://www.facebook.com/wttt_official/" target="_blank" class="social-link">
        <i class="fab fa-facebook"></i>
        <span>Facebook</span>
      </a>
      <a href="https://twitter.com/wttt_official/" target="_blank" class="social-link">
        <i class="fab fa-twitter"></i>
        <span>Twitter</span>
      </a>
      <a href="https://www.tiktok.com/@wttt_official/" target="_blank" class="social-link">
        <i class="fab fa-tiktok"></i>
        <span>TikTok</span>
      </a>
      <a href="https://www.youtube.com/@wttt_official/" target="_blank" class="social-link">
        <i class="fab fa-youtube"></i>
        <span>YouTube</span>
      </a>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Upload Section -->
    <section class="upload-section">
      <div class="upload-card">
        <div class="upload-header">
          <i class="fas fa-cloud-upload-alt"></i>
          <h2>Upload New Image</h2>
        </div>
        <form id="upload-form" enctype="multipart/form-data" class="upload-form">
          <div class="file-upload-area">
            <input id="file-upload" type="file" name="image" accept="image/*" required />
            <label for="file-upload" class="file-upload-label">
              <i class="fas fa-camera"></i>
              <span>Choose image from iPhone or Gallery</span>
              <small>Drag & drop or click to browse</small>
            </label>
          </div>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-upload"></i>
            <span>Upload Image</span>
          </button>
        </form>
      </div>
    </section>

    <!-- Posts Grid -->
    <section class="posts-section">
      <div class="section-header">
        <h2>Content Queue</h2>
        <div class="section-actions">
          <button onclick="toggleBulkMode()" class="btn btn-outline" id="bulk-mode-btn">
            <i class="fas fa-check-square"></i>
            <span>Bulk Select</span>
          </button>
          <button onclick="bulkPost()" class="btn btn-primary" id="bulk-post-btn" style="display: none;">
            <i class="fas fa-paper-plane"></i>
            <span>Post Selected</span>
          </button>
        </div>
      </div>
      
      <div id="posts-container" class="posts-grid"></div>
      
      <div id="loading-indicator" class="loading-indicator" style="display: none;">
        <div class="spinner"></div>
        <span>Loading content...</span>
      </div>
      
      <div id="empty-state" class="empty-state" style="display: none;">
        <i class="fas fa-images"></i>
        <h3>No content available</h3>
        <p>Upload an image or pull new content to get started</p>
      </div>
    </section>
  </main>

  <!-- Toast Notifications -->
  <div id="toast-container" class="toast-container"></div>

  <script src="app.js" defer></script>

  <script>
    const API_BASE = 'https://autopostdashboard-production.up.railway.app';
    const TRIGGER_URL = `${API_BASE}/trigger-upload`;
    const POSTS_JSON_URL = `https://raw.githubusercontent.com/WELCOMETOTHETRIBE/auto_post_dashboard/main/public/posts.json?cacheBust=${Date.now()}`;

    let selectedPosts = new Set();
    let isBulkMode = false;

    // Toast notification system
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
        <span>${message}</span>
      `;
      
      document.getElementById('toast-container').appendChild(toast);
      
      setTimeout(() => {
        toast.classList.add('show');
      }, 100);
      
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Upload form handling
    document.getElementById('upload-form').addEventListener('submit', async function (e) {
      e.preventDefault();
      const formData = new FormData(this);
      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      
      try {
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Uploading...</span>';
        submitBtn.disabled = true;
        
        const res = await fetch('/upload-image', {
          method: 'POST',
          body: formData
        });
        
        if (!res.ok) throw new Error('Upload failed');
        
        const data = await res.json();
        showToast('✅ Image uploaded successfully!', 'success');
        this.reset();
        setTimeout(() => location.reload(), 1000);
      } catch (err) {
        console.error('Upload failed:', err);
        showToast('❌ Upload failed. Please try again.', 'error');
      } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    });

    // File upload visual feedback
    document.getElementById('file-upload').addEventListener('change', function(e) {
      const label = document.querySelector('.file-upload-label');
      if (e.target.files.length > 0) {
        label.innerHTML = `
          <i class="fas fa-check-circle"></i>
          <span>${e.target.files[0].name}</span>
          <small>Ready to upload</small>
        `;
        label.classList.add('has-file');
      } else {
        label.innerHTML = `
          <i class="fas fa-camera"></i>
          <span>Choose image from iPhone or Gallery</span>
          <small>Drag & drop or click to browse</small>
        `;
        label.classList.remove('has-file');
      }
    });

    function generateTokenId() {
      return 'token_' + Math.random().toString(36).substring(2, 10);
    }

    function togglePlatform(button, input) {
      button.classList.toggle('active');
      const platforms = Array.from(button.parentElement.querySelectorAll('.platform-button.active')).map(btn => btn.dataset.platform);
      input.value = platforms.join(' ');
    }

    function toggleBulkMode() {
      isBulkMode = !isBulkMode;
      selectedPosts.clear();
      
      const bulkBtn = document.getElementById('bulk-mode-btn');
      const bulkPostBtn = document.getElementById('bulk-post-btn');
      const posts = document.querySelectorAll('.post');
      
      if (isBulkMode) {
        bulkBtn.innerHTML = '<i class="fas fa-times"></i><span>Cancel</span>';
        bulkBtn.classList.add('active');
        bulkPostBtn.style.display = 'inline-flex';
        posts.forEach(post => {
          post.classList.add('bulk-selectable');
          post.addEventListener('click', () => togglePostSelection(post));
        });
      } else {
        bulkBtn.innerHTML = '<i class="fas fa-check-square"></i><span>Bulk Select</span>';
        bulkBtn.classList.remove('active');
        bulkPostBtn.style.display = 'none';
        posts.forEach(post => {
          post.classList.remove('bulk-selectable', 'selected');
          post.removeEventListener('click', () => togglePostSelection(post));
        });
      }
    }

    function togglePostSelection(post) {
      const postId = post.dataset.postId;
      if (selectedPosts.has(postId)) {
        selectedPosts.delete(postId);
        post.classList.remove('selected');
      } else {
        selectedPosts.add(postId);
        post.classList.add('selected');
      }
      
      const bulkPostBtn = document.getElementById('bulk-post-btn');
      bulkPostBtn.innerHTML = `<i class="fas fa-paper-plane"></i><span>Post Selected (${selectedPosts.size})</span>`;
    }

    async function bulkPost() {
      if (selectedPosts.size === 0) {
        showToast('Please select at least one post', 'error');
        return;
      }
      
      const selectedElements = Array.from(selectedPosts).map(id => 
        document.querySelector(`[data-post-id="${id}"]`)
      );
      
      for (const element of selectedElements) {
        await submitToSheet(
          element.dataset.index,
          element.dataset.imageUrl,
          element.dataset.tokenId,
          element.querySelector('.post-now-btn')
        );
      }
    }

    function loadPosts() {
      const container = document.getElementById('posts-container');
      const loadingIndicator = document.getElementById('loading-indicator');
      const emptyState = document.getElementById('empty-state');
      
      loadingIndicator.style.display = 'flex';
      container.innerHTML = '';
      
      fetch(POSTS_JSON_URL)
        .then(res => res.json())
        .then(data => {
          const visiblePosts = data.filter(post => post.status !== 'hidden');
          
          if (visiblePosts.length === 0) {
            emptyState.style.display = 'flex';
            loadingIndicator.style.display = 'none';
            return;
          }
          
          visiblePosts.forEach((post, index) => {
            const tokenId = generateTokenId();
            const postElement = createPostElement(post, index, tokenId);
            container.appendChild(postElement);
          });
          
          loadingIndicator.style.display = 'none';
        })
        .catch(err => {
          console.error('❌ Failed to load posts.json:', err);
          showToast('Could not load posts from GitHub.', 'error');
          loadingIndicator.style.display = 'none';
          emptyState.style.display = 'flex';
        });
    }

    function createPostElement(post, index, tokenId) {
      const postElement = document.createElement('div');
      postElement.className = 'post';
      postElement.dataset.postId = tokenId;
      postElement.dataset.index = index;
      postElement.dataset.imageUrl = post.image_url;
      postElement.dataset.tokenId = tokenId;
      
      postElement.innerHTML = `
        <div class="post-header">
          <div class="post-image">
            <img src="${post.image_url}" alt="Post image" loading="lazy" />
            <div class="image-overlay">
              <button class="btn btn-sm btn-outline" onclick="previewImage('${post.image_url}')">
                <i class="fas fa-expand"></i>
              </button>
            </div>
          </div>
          <div class="post-actions">
            <button class="btn btn-sm btn-outline" onclick="togglePostDetails(this)">
              <i class="fas fa-edit"></i>
              <span>Edit</span>
            </button>
          </div>
        </div>
        
        <div class="post-details" style="display: none;">
          <div class="form-group">
            <label for="product-${index}">Product Category</label>
            <select id="product-${index}" class="form-control">
              <option value="N/A">Select Product</option>
              <option value="THRIVE">THRIVE</option>
              <option value="DRIVE">DRIVE</option>
              <option value="ALIGN">ALIGN</option>
              <option value="Clusters">Clusters</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="prompt-${index}">Image Description</label>
            <textarea id="prompt-${index}" class="form-control" placeholder="Describe the image or message...">${post.caption || ''}</textarea>
          </div>
          
          <div class="form-group">
            <label for="caption-${index}">Generated Caption</label>
            <div class="input-group">
              <textarea id="caption-${index}" class="form-control" placeholder="Click generate to create a caption"></textarea>
              <button class="btn btn-sm btn-secondary" onclick="generateCaption(${index})">
                <i class="fas fa-magic"></i>
                <span>Generate</span>
              </button>
            </div>
          </div>
          
          <div class="form-group">
            <label for="hashtags-${index}">Generated Hashtags</label>
            <div class="input-group">
              <input type="text" id="hashtags-${index}" class="form-control" placeholder="Click generate to create hashtags" />
              <button class="btn btn-sm btn-secondary" onclick="generateHashtags(${index})">
                <i class="fas fa-hashtag"></i>
                <span>Generate</span>
              </button>
            </div>
          </div>
          
          <div class="form-group">
            <label for="link-${index}">Link</label>
            <input type="text" id="link-${index}" class="form-control" value="${post.link || ''}" placeholder="Optional link" />
          </div>
          
          <div class="form-group">
            <label>Platforms</label>
            <div class="platform-buttons">
              <button type="button" class="platform-button" data-platform="Instagram" onclick="togglePlatform(this, document.getElementById('platform-${index}'))">
                <i class="fab fa-instagram"></i>
                <span>Instagram</span>
              </button>
              <button type="button" class="platform-button" data-platform="Facebook" onclick="togglePlatform(this, document.getElementById('platform-${index}'))">
                <i class="fab fa-facebook"></i>
                <span>Facebook</span>
              </button>
              <button type="button" class="platform-button" data-platform="LinkedIn" onclick="togglePlatform(this, document.getElementById('platform-${index}'))">
                <i class="fab fa-linkedin"></i>
                <span>LinkedIn</span>
              </button>
              <button type="button" class="platform-button" data-platform="X" onclick="togglePlatform(this, document.getElementById('platform-${index}'))">
                <i class="fab fa-twitter"></i>
                <span>X (Twitter)</span>
              </button>
              <button type="button" class="platform-button" data-platform="Pinterest" onclick="togglePlatform(this, document.getElementById('platform-${index}'))">
                <i class="fab fa-pinterest"></i>
                <span>Pinterest</span>
              </button>
              <button type="button" class="platform-button" data-platform="Reddit" onclick="togglePlatform(this, document.getElementById('platform-${index}'))">
                <i class="fab fa-reddit"></i>
                <span>Reddit</span>
              </button>
            </div>
            <input type="hidden" id="platform-${index}" value="${post.platform || ''}" />
          </div>
          
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="publish-${index}">
              <span class="checkmark"></span>
              Publish immediately
            </label>
          </div>
        </div>
        
        <div class="post-footer">
          <button class="btn btn-primary post-now-btn" onclick="submitToSheet(${index}, '${post.image_url}', '${tokenId}', this)">
            <i class="fas fa-paper-plane"></i>
            <span>Post Now</span>
          </button>
        </div>
      `;
      
      return postElement;
    }

    function togglePostDetails(button) {
      const post = button.closest('.post');
      const details = post.querySelector('.post-details');
      const isVisible = details.style.display !== 'none';
      
      if (isVisible) {
        details.style.display = 'none';
        button.innerHTML = '<i class="fas fa-edit"></i><span>Edit</span>';
      } else {
        details.style.display = 'block';
        button.innerHTML = '<i class="fas fa-chevron-up"></i><span>Collapse</span>';
      }
    }

    function previewImage(imageUrl) {
      const modal = document.createElement('div');
      modal.className = 'image-modal';
      modal.innerHTML = `
        <div class="modal-content">
          <button class="modal-close" onclick="this.closest('.image-modal').remove()">
            <i class="fas fa-times"></i>
          </button>
          <img src="${imageUrl}" alt="Preview" />
        </div>
      `;
      document.body.appendChild(modal);
      
      setTimeout(() => modal.classList.add('show'), 10);
    }

    async function submitToSheet(index, image_url, tokenId, button) {
      const caption = document.getElementById(`caption-${index}`).value;
      const hashtags = document.getElementById(`hashtags-${index}`).value;
      const platform = document.getElementById(`platform-${index}`).value;
      const publish_now = document.getElementById(`publish-${index}`).checked;
      const link = document.getElementById(`link-${index}`).value;
      const product = document.getElementById(`product-${index}`).value;

      if (!caption.trim()) {
        showToast('Please add a caption before posting', 'error');
        return;
      }

      const payload = {
        image_url,
        caption,
        hashtags,
        platform,
        publish_now,
        token_id: tokenId,
        link,
        product
      };

      const originalText = button.innerHTML;
      button.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Posting...</span>';
      button.disabled = true;

      try {
        const res = await fetch(`${API_BASE}/submit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        if (!res.ok) throw new Error('Post failed');
        
        showToast('✅ Post submitted successfully!', 'success');
        button.closest('.post').remove();
      } catch (error) {
        console.error('Error submitting to Zapier or hiding post:', error);
        showToast('❌ Error submitting post. Please try again.', 'error');
      } finally {
        button.innerHTML = originalText;
        button.disabled = false;
      }
    }

    async function generateCaption(index) {
      const prompt = document.getElementById(`prompt-${index}`).value;
      const captionField = document.getElementById(`caption-${index}`);
      const generateBtn = captionField.nextElementSibling;
      
      if (!prompt.trim()) {
        showToast('Please describe the image first', 'error');
        return;
      }

      const originalText = generateBtn.innerHTML;
      generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Generating...</span>';
      generateBtn.disabled = true;
      captionField.placeholder = "⏳ Generating caption...";

      try {
        const res = await fetch(`${API_BASE}/api/generate-caption`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt })
        });
        
        if (!res.ok) throw new Error('Generation failed');
        
        const data = await res.json();
        captionField.value = data.caption || '';
        showToast('✅ Caption generated!', 'success');
      } catch (error) {
        console.error('Error generating caption:', error);
        showToast('❌ Failed to generate caption.', 'error');
      } finally {
        generateBtn.innerHTML = originalText;
        generateBtn.disabled = false;
        captionField.placeholder = "Click generate to create a caption";
      }
    }

    async function generateHashtags(index) {
      const caption = document.getElementById(`caption-${index}`).value;
      const hashtagsField = document.getElementById(`hashtags-${index}`);
      const generateBtn = hashtagsField.nextElementSibling;
      
      if (!caption.trim()) {
        showToast('Please add a caption first', 'error');
        return;
      }

      const originalText = generateBtn.innerHTML;
      generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Generating...</span>';
      generateBtn.disabled = true;
      hashtagsField.placeholder = "⏳ Generating hashtags...";

      try {
        const res = await fetch(`${API_BASE}/api/generate-hashtags`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ caption })
        });
        
        if (!res.ok) throw new Error('Generation failed');
        
        const data = await res.json();
        hashtagsField.value = data.hashtags || '';
        showToast('✅ Hashtags generated!', 'success');
      } catch (error) {
        console.error('Error generating hashtags:', error);
        showToast('❌ Failed to generate hashtags.', 'error');
      } finally {
        generateBtn.innerHTML = originalText;
        generateBtn.disabled = false;
        hashtagsField.placeholder = "Click generate to create hashtags";
      }
    }

    async function triggerUpload() {
      const btn = document.querySelector('.header-actions button');
      const originalText = btn.innerHTML;
      
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Pulling...</span>';
      btn.disabled = true;

      try {
        const res = await fetch(TRIGGER_URL, { method: 'POST' });
        if (!res.ok) throw new Error('Pull failed');
        
        const data = await res.json();
        showToast('🆕 New images pulled successfully!', 'success');
        setTimeout(() => location.reload(), 1000);
      } catch (error) {
        console.error('❌ Error triggering pull:', error);
        showToast('❌ Failed to pull new images.', 'error');
      } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }

    window.onload = loadPosts;
  </script>
</body>
</html>
