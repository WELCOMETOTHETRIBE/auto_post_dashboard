<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Multi-Brand Content Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Sidebar Navigation -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo">
        <i class="fas fa-leaf"></i>
        <h1>Content Hub</h1>
      </div>
      <p class="tagline">Multi-Brand Dashboard</p>
    </div>
    
    <!-- Profile Selector -->
    <div class="profile-selector">
      <div class="profile-header">
        <h3>Active Brand</h3>
        <button onclick="toggleProfileModal()" class="profile-change-btn">
          <i class="fas fa-edit"></i>
        </button>
      </div>
      <div class="active-profile" id="active-profile">
        <div class="profile-avatar">
          <i class="fas fa-leaf"></i>
        </div>
        <div class="profile-info">
          <span class="profile-name">WELCOME TO THE TRIBE</span>
          <span class="profile-type">FruTropics Brand</span>
        </div>
      </div>
    </div>
    
    <nav class="sidebar-nav">
      <div class="nav-section">
        <h3>Quick Actions</h3>
        <button onclick="triggerUpload()" class="nav-btn primary">
          <i class="fas fa-sync-alt"></i>
          <span>Pull New Content</span>
        </button>
        <button onclick="toggleUploadModal()" class="nav-btn">
          <i class="fas fa-cloud-upload-alt"></i>
          <span>Upload Media</span>
        </button>
      </div>
      
      <div class="nav-section">
        <h3>Social Platforms</h3>
        <div class="social-links">
          <a href="https://www.instagram.com/wttt_official/" target="_blank" class="social-link">
            <i class="fab fa-instagram"></i>
            <span>Instagram</span>
          </a>
          <a href="https://www.facebook.com/wttt_official/" target="_blank" class="social-link">
            <i class="fab fa-facebook"></i>
            <span>Facebook</span>
          </a>
          <a href="https://twitter.com/wttt_official/" target="_blank" class="social-link">
            <i class="fab fa-twitter"></i>
            <span>Twitter</span>
          </a>
          <a href="https://www.tiktok.com/@wttt_official/" target="_blank" class="social-link">
            <i class="fab fa-tiktok"></i>
            <span>TikTok</span>
          </a>
          <a href="https://www.reddit.com/r/wttt_official/" target="_blank" class="social-link">
            <i class="fab fa-reddit"></i>
            <span>Reddit</span>
          </a>
          <a href="https://www.youtube.com/@wttt_official/" target="_blank" class="social-link">
            <i class="fab fa-youtube"></i>
            <span>YouTube</span>
          </a>
        </div>
      </div>
      
      <div class="nav-section">
        <h3>Analytics</h3>
        <div class="analytics-summary">
          <div class="analytics-item">
            <span class="analytics-number" id="total-posts">0</span>
            <span class="analytics-label">Total Posts</span>
          </div>
          <div class="analytics-item">
            <span class="analytics-number" id="scheduled-posts">0</span>
            <span class="analytics-label">Scheduled</span>
          </div>
          <div class="analytics-item">
            <span class="analytics-number" id="engagement-rate">0%</span>
            <span class="analytics-label">Engagement</span>
          </div>
        </div>
      </div>
    </nav>
  </aside>

  <!-- Main Content Area -->
  <main class="main-content">
    <!-- Top Header -->
    <header class="top-header">
      <div class="header-left">
        <h2>Content Queue</h2>
        <p class="subtitle">Manage and schedule posts for <span id="current-brand">WELCOME TO THE TRIBE</span></p>
      </div>
      <div class="header-right">
        <div class="view-controls">
          <button class="view-btn active" onclick="setViewMode('grid')">
            <i class="fas fa-th"></i>
          </button>
          <button class="view-btn" onclick="setViewMode('list')">
            <i class="fas fa-list"></i>
          </button>
        </div>
        <button onclick="toggleBulkMode()" class="btn btn-outline" id="bulk-mode-btn">
          <i class="fas fa-check-square"></i>
          <span>Bulk Select</span>
        </button>
        <button onclick="bulkPost()" class="btn btn-primary" id="bulk-post-btn" style="display: none;">
          <i class="fas fa-paper-plane"></i>
          <span>Post Selected</span>
        </button>
      </div>
    </header>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
      <button class="tab-btn active" onclick="switchTab('active')" id="active-tab">
        <i class="fas fa-clock"></i>
        <span>Active Posts</span>
        <span class="tab-count" id="active-count">0</span>
      </button>
      <button class="tab-btn" onclick="switchTab('posted')" id="posted-tab">
        <i class="fas fa-check-circle"></i>
        <span>Posted</span>
        <span class="tab-count" id="posted-count">0</span>
      </button>
    </div>

    <!-- Content Grid -->
    <div class="content-area">
      <div id="posts-container" class="posts-grid"></div>
      
      <div id="loading-indicator" class="loading-indicator" style="display: none;">
        <div class="spinner"></div>
        <span>Loading content...</span>
      </div>
      
      <div id="empty-state" class="empty-state" style="display: none;">
        <div class="empty-icon">
          <i class="fas fa-images"></i>
        </div>
        <h3>No content available</h3>
        <p>Upload new media or pull content to get started</p>
        <button onclick="toggleUploadModal()" class="btn btn-primary">
          <i class="fas fa-plus"></i>
          <span>Add Content</span>
        </button>
      </div>
    </div>
  </main>

  <!-- Profile Selection Modal -->
  <div id="profile-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Select Brand Profile</h3>
        <button onclick="toggleProfileModal()" class="modal-close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="profile-options">
        <div class="profile-option active" onclick="selectProfile('wttt', 'WELCOME TO THE TRIBE', 'FruTropics Brand', 'fas fa-leaf')">
          <div class="profile-avatar">
            <i class="fas fa-leaf"></i>
          </div>
          <div class="profile-details">
            <span class="profile-name">WELCOME TO THE TRIBE</span>
            <span class="profile-type">FruTropics Brand</span>
          </div>
          <div class="profile-status">
            <i class="fas fa-check-circle"></i>
          </div>
        </div>
        
        <div class="profile-option" onclick="selectProfile('denly', 'Denly Gardens', 'Garden Brand', 'fas fa-seedling')">
          <div class="profile-avatar">
            <i class="fas fa-seedling"></i>
          </div>
          <div class="profile-details">
            <span class="profile-name">Denly Gardens</span>
            <span class="profile-type">Garden Brand</span>
          </div>
          <div class="profile-status">
            <i class="fas fa-circle"></i>
          </div>
        </div>
        
        <div class="profile-option" onclick="selectProfile('jabronis', 'Jabroni\'s', 'Sports Brand', 'fas fa-dumbbell')">
          <div class="profile-avatar">
            <i class="fas fa-dumbbell"></i>
          </div>
          <div class="profile-details">
            <span class="profile-name">Jabroni's</span>
            <span class="profile-type">Sports Brand</span>
          </div>
          <div class="profile-status">
            <i class="fas fa-circle"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Upload Modal -->
  <div id="upload-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Upload New Media</h3>
        <button onclick="toggleUploadModal()" class="modal-close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form id="upload-form" enctype="multipart/form-data" class="upload-form">
        <div class="file-upload-area">
          <input id="file-upload" type="file" name="image" accept="image/*,video/*" multiple required />
          <label for="file-upload" class="file-upload-label">
            <i class="fas fa-cloud-upload-alt"></i>
            <span>Choose files or drag & drop</span>
            <small>Supports images and videos</small>
          </label>
        </div>
        <div class="form-actions">
          <button type="button" onclick="toggleUploadModal()" class="btn btn-outline">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-upload"></i>
            <span>Upload Files</span>
          </button>
        </div>
      </form>
    </div>
  </div>



  <!-- Image Preview Modal -->
  <div id="image-modal" class="modal" style="display: none;">
    <div class="modal-content image-modal-content">
      <button onclick="closeImageModal()" class="modal-close">
        <i class="fas fa-times"></i>
      </button>
      <img id="preview-image" src="" alt="Preview" />
    </div>
  </div>

  <!-- Toast Notifications -->
  <div id="toast-container" class="toast-container"></div>

  <script>
    const API_BASE = 'https://autopostdashboard-production.up.railway.app';
    const TRIGGER_URL = `${API_BASE}/trigger-upload`;
    const POSTS_JSON_URL = `https://raw.githubusercontent.com/WELCOMETOTHETRIBE/auto_post_dashboard/main/public/posts.json?cacheBust=${Date.now()}`;

    let selectedPosts = new Set();
    let isBulkMode = false;
    let currentProfile = {
      id: 'wttt',
      name: 'WELCOME TO THE TRIBE',
      type: 'FruTropics Brand',
      icon: 'fas fa-leaf'
    };
    let viewMode = 'grid';
    let currentTab = 'active';
    let allPosts = [];
    let activePosts = [];
    let postedPosts = [];

    // Profile management
    function selectProfile(id, name, type, icon) {
      currentProfile = { id, name, type, icon };
      
      // Update active profile display
      document.getElementById('active-profile').innerHTML = `
        <div class="profile-avatar">
          <i class="${icon}"></i>
        </div>
        <div class="profile-info">
          <span class="profile-name">${name}</span>
          <span class="profile-type">${type}</span>
        </div>
      `;
      
      // Update header
      document.getElementById('current-brand').textContent = name;
      
      // Update profile modal
      document.querySelectorAll('.profile-option').forEach(option => {
        option.classList.remove('active');
      });
      event.currentTarget.classList.add('active');
      
      toggleProfileModal();
      showToast(`Switched to ${name}`, 'success');
    }

    function toggleProfileModal() {
      const modal = document.getElementById('profile-modal');
      modal.style.display = modal.style.display === 'none' ? 'flex' : 'none';
    }



    function setViewMode(mode) {
      viewMode = mode;
      const container = document.getElementById('posts-container');
      const buttons = document.querySelectorAll('.view-btn');
      
      buttons.forEach(btn => btn.classList.remove('active'));
      event.currentTarget.classList.add('active');
      
      container.className = `posts-${mode}`;
      displayPosts(); // Reload posts with new layout
    }

    function switchTab(tab) {
      currentTab = tab;
      const tabButtons = document.querySelectorAll('.tab-btn');
      const activeTab = document.getElementById('active-tab');
      const postedTab = document.getElementById('posted-tab');
      
      tabButtons.forEach(btn => btn.classList.remove('active'));
      
      if (tab === 'active') {
        activeTab.classList.add('active');
      } else {
        postedTab.classList.add('active');
      }
      
      displayPosts();
    }

    // Toast notification system
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
        <span>${message}</span>
      `;
      
      document.getElementById('toast-container').appendChild(toast);
      
      setTimeout(() => {
        toast.classList.add('show');
      }, 100);
      
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }

    // Modal functions
    function toggleUploadModal() {
      const modal = document.getElementById('upload-modal');
      modal.style.display = modal.style.display === 'none' ? 'flex' : 'none';
    }

    function closeImageModal() {
      document.getElementById('image-modal').style.display = 'none';
    }

    function previewImage(imageUrl) {
      const modal = document.getElementById('image-modal');
      const img = document.getElementById('preview-image');
      img.src = imageUrl;
      modal.style.display = 'flex';
    }

    // Upload form handling
    document.getElementById('upload-form').addEventListener('submit', async function (e) {
      e.preventDefault();
      const formData = new FormData(this);
      formData.append('profile', currentProfile.id);
      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      
      try {
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Uploading...</span>';
        submitBtn.disabled = true;
        
        const res = await fetch('/upload-image', {
          method: 'POST',
          body: formData
        });
        
        if (!res.ok) throw new Error('Upload failed');
        
        const data = await res.json();
        showToast('✅ Media uploaded successfully!', 'success');
        this.reset();
        toggleUploadModal();
        setTimeout(() => location.reload(), 1000);
      } catch (err) {
        console.error('Upload failed:', err);
        showToast('❌ Upload failed. Please try again.', 'error');
      } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    });

    // File upload visual feedback
    document.getElementById('file-upload').addEventListener('change', function(e) {
      const label = document.querySelector('.file-upload-label');
      if (e.target.files.length > 0) {
        const fileNames = Array.from(e.target.files).map(f => f.name).join(', ');
        label.innerHTML = `
          <i class="fas fa-check-circle"></i>
          <span>${e.target.files.length} file(s) selected</span>
          <small>${fileNames}</small>
        `;
        label.classList.add('has-file');
      } else {
        label.innerHTML = `
          <i class="fas fa-cloud-upload-alt"></i>
          <span>Choose files or drag & drop</span>
          <small>Supports images and videos</small>
        `;
        label.classList.remove('has-file');
      }
    });

    function generateTokenId() {
      return 'token_' + Math.random().toString(36).substring(2, 10);
    }

    function togglePlatform(button, input) {
      button.classList.toggle('active');
      const platforms = Array.from(button.parentElement.querySelectorAll('.platform-button.active')).map(btn => btn.dataset.platform);
      input.value = platforms.join(' ');
    }

    function toggleBulkMode() {
      isBulkMode = !isBulkMode;
      selectedPosts.clear();
      
      const bulkBtn = document.getElementById('bulk-mode-btn');
      const bulkPostBtn = document.getElementById('bulk-post-btn');
      const posts = document.querySelectorAll('.post');
      
      if (isBulkMode) {
        bulkBtn.innerHTML = '<i class="fas fa-times"></i><span>Cancel</span>';
        bulkBtn.classList.add('active');
        bulkPostBtn.style.display = 'inline-flex';
        posts.forEach(post => {
          post.classList.add('bulk-selectable');
          post.addEventListener('click', () => togglePostSelection(post));
        });
      } else {
        bulkBtn.innerHTML = '<i class="fas fa-check-square"></i><span>Bulk Select</span>';
        bulkBtn.classList.remove('active');
        bulkPostBtn.style.display = 'none';
        posts.forEach(post => {
          post.classList.remove('bulk-selectable', 'selected');
          post.removeEventListener('click', () => togglePostSelection(post));
        });
      }
    }

    function togglePostSelection(post) {
      const postId = post.dataset.postId;
      if (selectedPosts.has(postId)) {
        selectedPosts.delete(postId);
        post.classList.remove('selected');
      } else {
        selectedPosts.add(postId);
        post.classList.add('selected');
      }
      
      const bulkPostBtn = document.getElementById('bulk-post-btn');
      bulkPostBtn.innerHTML = `<i class="fas fa-paper-plane"></i><span>Post Selected (${selectedPosts.size})</span>`;
    }

    async function bulkPost() {
      if (selectedPosts.size === 0) {
        showToast('Please select at least one post', 'error');
        return;
      }
      
      const selectedElements = Array.from(selectedPosts).map(id => 
        document.querySelector(`[data-post-id="${id}"]`)
      );
      
      for (const element of selectedElements) {
        await submitToSheet(
          element.dataset.index,
          element.dataset.imageUrl,
          element.dataset.tokenId,
          element.querySelector('.post-now-btn')
        );
      }
    }

    function loadPosts() {
      const container = document.getElementById('posts-container');
      const loadingIndicator = document.getElementById('loading-indicator');
      const emptyState = document.getElementById('empty-state');
      
      loadingIndicator.style.display = 'flex';
      container.innerHTML = '';
      
      fetch(POSTS_JSON_URL)
        .then(res => res.json())
        .then(data => {
          allPosts = data;
          activePosts = data.filter(post => post.status !== 'hidden');
          postedPosts = data.filter(post => post.status === 'hidden');
          
          // Update tab counts
          document.getElementById('active-count').textContent = activePosts.length;
          document.getElementById('posted-count').textContent = postedPosts.length;
          
          // Update analytics
          document.getElementById('total-posts').textContent = allPosts.length;
          document.getElementById('scheduled-posts').textContent = Math.floor(activePosts.length * 0.3);
          document.getElementById('engagement-rate').textContent = '4.2%';
          
          displayPosts();
          loadingIndicator.style.display = 'none';
        })
        .catch(err => {
          console.error('❌ Failed to load posts.json:', err);
          showToast('Could not load posts from GitHub.', 'error');
          loadingIndicator.style.display = 'none';
          emptyState.style.display = 'flex';
        });
    }

    function displayPosts() {
      const container = document.getElementById('posts-container');
      const emptyState = document.getElementById('empty-state');
      
      container.innerHTML = '';
      
      const postsToShow = currentTab === 'active' ? activePosts : postedPosts;
      
      if (postsToShow.length === 0) {
        emptyState.style.display = 'flex';
        emptyState.querySelector('h3').textContent = currentTab === 'active' ? 'No active content' : 'No posted content';
        emptyState.querySelector('p').textContent = currentTab === 'active' ? 'Upload new media or pull content to get started' : 'No posts have been published yet';
        return;
      }
      
      emptyState.style.display = 'none';
      
      postsToShow.forEach((post, index) => {
        const tokenId = generateTokenId();
        const postElement = createPostElement(post, index, tokenId);
        container.appendChild(postElement);
      });
    }

    function createPostElement(post, index, tokenId) {
      const postElement = document.createElement('div');
      postElement.className = 'post';
      postElement.dataset.postId = tokenId;
      postElement.dataset.index = index;
      postElement.dataset.imageUrl = post.image_url;
      postElement.dataset.tokenId = tokenId;
      
      const isPosted = post.status === 'hidden';
      const postedDate = post.posted_date || new Date().toLocaleDateString();
      
      postElement.innerHTML = `
        <div class="post-header">
          <div class="post-image">
            <img src="${post.image_url}" alt="Post image" loading="lazy" />
            <div class="image-overlay">
              <button class="btn btn-sm btn-outline" onclick="previewImage('${post.image_url}')">
                <i class="fas fa-expand"></i>
              </button>
            </div>
            ${isPosted ? `<div class="posted-badge">
              <i class="fas fa-check-circle"></i>
              <span>Posted</span>
            </div>` : ''}
          </div>
          ${!isPosted ? `<div class="post-actions">
            <button class="btn btn-sm btn-outline" onclick="togglePostDetails(this)">
              <i class="fas fa-edit"></i>
              <span>Edit</span>
            </button>
          </div>` : ''}
        </div>
        
        ${isPosted ? `
        <div class="post-info">
          <div class="post-meta">
            <span class="posted-date">
              <i class="fas fa-calendar"></i>
              Posted on ${postedDate}
            </span>
            ${post.platform ? `<span class="posted-platform">
              <i class="fas fa-share"></i>
              ${post.platform}
            </span>` : ''}
          </div>
          ${post.caption ? `<div class="posted-caption">
            <strong>Caption:</strong> ${post.caption}
          </div>` : ''}
          ${post.hashtags ? `<div class="posted-hashtags">
            <strong>Hashtags:</strong> ${post.hashtags}
          </div>` : ''}
        </div>
        ` : `
        <div class="post-details" style="display: none;">
          <div class="form-row">
            <div class="form-group">
              <label for="product-${index}">Product Category</label>
              <select id="product-${index}" class="form-control">
                <option value="N/A">Select Product</option>
                <option value="THRIVE">THRIVE</option>
                <option value="DRIVE">DRIVE</option>
                <option value="ALIGN">ALIGN</option>
                <option value="Clusters">Clusters</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="link-${index}">Link</label>
              <input type="text" id="link-${index}" class="form-control" value="${post.link || ''}" placeholder="Optional link" />
            </div>
          </div>
          
          <div class="form-group">
            <label for="prompt-${index}">Image Description</label>
            <textarea id="prompt-${index}" class="form-control" placeholder="Describe the image or message...">${post.caption || ''}</textarea>
          </div>
          
          <div class="form-group">
            <label for="caption-${index}">Generated Caption</label>
            <div class="input-group">
              <textarea id="caption-${index}" class="form-control" placeholder="Click generate to create a caption"></textarea>
              <button class="btn btn-sm btn-secondary" onclick="generateCaption(${index})">
                <i class="fas fa-magic"></i>
                <span>Generate</span>
              </button>
            </div>
          </div>
          
          <div class="form-group">
            <label for="hashtags-${index}">Generated Hashtags</label>
            <div class="input-group">
              <input type="text" id="hashtags-${index}" class="form-control" placeholder="Click generate to create hashtags" />
              <button class="btn btn-sm btn-secondary" onclick="generateHashtags(${index})">
                <i class="fas fa-hashtag"></i>
                <span>Generate</span>
              </button>
            </div>
          </div>
          
          <div class="form-group">
            <label>Platforms</label>
            <div class="platform-buttons">
              <button type="button" class="platform-button" data-platform="Instagram" onclick="togglePlatform(this, document.getElementById('platform-${index}'))">
                <i class="fab fa-instagram"></i>
                <span>Instagram</span>
              </button>
              <button type="button" class="platform-button" data-platform="Facebook" onclick="togglePlatform(this, document.getElementById('platform-${index}'))">
                <i class="fab fa-facebook"></i>
                <span>Facebook</span>
              </button>
              <button type="button" class="platform-button" data-platform="LinkedIn" onclick="togglePlatform(this, document.getElementById('platform-${index}'))">
                <i class="fab fa-linkedin"></i>
                <span>LinkedIn</span>
              </button>
              <button type="button" class="platform-button" data-platform="X" onclick="togglePlatform(this, document.getElementById('platform-${index}'))">
                <i class="fab fa-twitter"></i>
                <span>X (Twitter)</span>
              </button>
              <button type="button" class="platform-button" data-platform="Pinterest" onclick="togglePlatform(this, document.getElementById('platform-${index}'))">
                <i class="fab fa-pinterest"></i>
                <span>Pinterest</span>
              </button>
              <button type="button" class="platform-button" data-platform="Reddit" onclick="togglePlatform(this, document.getElementById('platform-${index}'))">
                <i class="fab fa-reddit"></i>
                <span>Reddit</span>
              </button>
            </div>
            <input type="hidden" id="platform-${index}" value="${post.platform || ''}" />
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="delay-${index}">Delay (hours)</label>
              <input type="number" id="delay-${index}" class="form-control" value="0" min="0" max="168" placeholder="0" />
              <small class="form-help">Set to 0 for immediate posting, or enter hours to delay</small>
            </div>
            
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" id="publish-${index}">
                <span class="checkmark"></span>
                Publish immediately
              </label>
            </div>
          </div>
        </div>
        
        <div class="post-footer">
          <button class="btn btn-primary post-now-btn" onclick="submitToSheet(${index}, '${post.image_url}', '${tokenId}', this)">
            <i class="fas fa-paper-plane"></i>
            <span>Post Now</span>
          </button>
        </div>
        `}
      `;
      
      return postElement;
    }

    function togglePostDetails(button) {
      const post = button.closest('.post');
      const details = post.querySelector('.post-details');
      const isVisible = details.style.display !== 'none';
      
      if (isVisible) {
        details.style.display = 'none';
        button.innerHTML = '<i class="fas fa-edit"></i><span>Edit</span>';
      } else {
        details.style.display = 'block';
        button.innerHTML = '<i class="fas fa-chevron-up"></i><span>Collapse</span>';
      }
    }

    async function submitToSheet(index, image_url, tokenId, button) {
      const caption = document.getElementById(`caption-${index}`).value;
      const hashtags = document.getElementById(`hashtags-${index}`).value;
      const platform = document.getElementById(`platform-${index}`).value;
      const publish_now = document.getElementById(`publish-${index}`).checked;
      const link = document.getElementById(`link-${index}`).value;
      const product = document.getElementById(`product-${index}`).value;
      const delay_hours = parseInt(document.getElementById(`delay-${index}`).value) || 0;

      if (!caption.trim()) {
        showToast('Please add a caption before posting', 'error');
        return;
      }

      const payload = {
        image_url,
        caption,
        hashtags,
        platform,
        publish_now,
        token_id: tokenId,
        link,
        product,
        profile: currentProfile.id,
        delay_hours
      };

      const originalText = button.innerHTML;
      button.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Posting...</span>';
      button.disabled = true;

      try {
        const res = await fetch(`${API_BASE}/submit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        if (!res.ok) throw new Error('Post failed');
        
        showToast('✅ Post submitted successfully!', 'success');
        button.closest('.post').remove();
      } catch (error) {
        console.error('Error submitting to Zapier or hiding post:', error);
        showToast('❌ Error submitting post. Please try again.', 'error');
      } finally {
        button.innerHTML = originalText;
        button.disabled = false;
      }
    }

    async function generateCaption(index) {
      const prompt = document.getElementById(`prompt-${index}`).value;
      const captionField = document.getElementById(`caption-${index}`);
      const generateBtn = captionField.nextElementSibling;
      
      if (!prompt.trim()) {
        showToast('Please describe the image first', 'error');
        return;
      }

      const originalText = generateBtn.innerHTML;
      generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Generating...</span>';
      generateBtn.disabled = true;
      captionField.placeholder = "⏳ Generating caption...";

      try {
        const res = await fetch(`${API_BASE}/api/generate-caption`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt })
        });
        
        if (!res.ok) throw new Error('Generation failed');
        
        const data = await res.json();
        captionField.value = data.caption || '';
        showToast('✅ Caption generated!', 'success');
      } catch (error) {
        console.error('Error generating caption:', error);
        showToast('❌ Failed to generate caption.', 'error');
      } finally {
        generateBtn.innerHTML = originalText;
        generateBtn.disabled = false;
        captionField.placeholder = "Click generate to create a caption";
      }
    }

    async function generateHashtags(index) {
      const caption = document.getElementById(`caption-${index}`).value;
      const hashtagsField = document.getElementById(`hashtags-${index}`);
      const generateBtn = hashtagsField.nextElementSibling;
      
      if (!caption.trim()) {
        showToast('Please add a caption first', 'error');
        return;
      }

      const originalText = generateBtn.innerHTML;
      generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Generating...</span>';
      generateBtn.disabled = true;
      hashtagsField.placeholder = "⏳ Generating hashtags...";

      try {
        const res = await fetch(`${API_BASE}/api/generate-hashtags`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ caption })
        });
        
        if (!res.ok) throw new Error('Generation failed');
        
        const data = await res.json();
        hashtagsField.value = data.hashtags || '';
        showToast('✅ Hashtags generated!', 'success');
      } catch (error) {
        console.error('Error generating hashtags:', error);
        showToast('❌ Failed to generate hashtags.', 'error');
      } finally {
        generateBtn.innerHTML = originalText;
        generateBtn.disabled = false;
        hashtagsField.placeholder = "Click generate to create hashtags";
      }
    }

    async function triggerUpload() {
      const btn = document.querySelector('.nav-btn.primary');
      const originalText = btn.innerHTML;
      
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Pulling...</span>';
      btn.disabled = true;

      try {
        const res = await fetch(TRIGGER_URL, { method: 'POST' });
        if (!res.ok) throw new Error('Pull failed');
        
        const data = await res.json();
        showToast('🆕 New content pulled successfully!', 'success');
        setTimeout(() => location.reload(), 1000);
      } catch (error) {
        console.error('❌ Error triggering pull:', error);
        showToast('❌ Failed to pull new content.', 'error');
      } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }

    // Close modals when clicking outside
    window.addEventListener('click', function(e) {
      const modals = ['upload-modal', 'profile-modal', 'image-modal'];
      modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (e.target === modal) {
          if (modalId === 'upload-modal') toggleUploadModal();
          if (modalId === 'profile-modal') toggleProfileModal();
          if (modalId === 'image-modal') closeImageModal();
        }
      });
    });

    window.onload = loadPosts;
  </script>
</body>
</html>
